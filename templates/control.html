<!DOCTYPE html>
<html>
<head>
    <title>Telescope Control</title>
    <link rel="stylesheet" href="../static/style.css" />
</head>
<body>
    <h1>Telescope Control</h1>
    <div class="telescope-container">
        <div id="control-buttons">
            <table>
                <tr>
                    <img src="../static/PIPITREK.webp" style="width: 100%; max-width: 200px; margin-top: 0px; ">
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <button class="control-button" onclick="sendDirection('n')">↑</button>
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <td>
                        <button class="control-button" onclick="sendDirection('e')">←</button>
                    </td>
                    <td><button class="control-button" onclick="sendStop()">Stop</button></td>
                    <td>
                        <button class="control-button" onclick="sendDirection('w')">→</button>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <button class="control-button" onclick="sendDirection('s')">↓</button>
                    </td>
                    <td></td>
                </tr>
            </table>       
        </div>

        <div id="command-buttons">
            
            <button class="command-button" onclick="sendAutoguiderCommand(true)">Start Autoguider</button>
            <button class="command-button" onclick="sendAutoguiderCommand(false)">Stop Autoguider</button>
            <button class="command-button" onclick="getInfo()">Get Info</button>
            <button class="command-button" onclick="receivePEC()">Receive PEC</button>
            <button class="command-button" onclick="sendPEC()">Send PEC</button>
            <button class="command-button" onclick="resetArduino()">Reset Arduino</button>
            <button class="command-button" onclick="showTerminal()">Terminal</button>
            <div>
                <label>Pier:</label>
                <input type="radio" id="pier_w" name="pier" value="W" onchange="setPier(this.value)">
                <label for="pier_w">W</label>
                <input type="radio" id="pier_e" name="pier" value="E" onchange="setPier(this.value)">
                <label for="pier_e">E</label>
            </div>
            <div>
                <input type="checkbox" id="tracking" onchange="setTracking(this.checked)" checked>
                <label for="tracking">Tracking</label>
             </div>

            <div id="upload-firmware">
                <p>Upload Firmware</p>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input class="command-button" type="file" id="firmware" name="firmware" accept=".hex">
                </form>
                <button class="command-button" type="button" onclick="uploadFirmware()">Upload</button>
            </div>
        </div>
        <div id="info-boxes" class = "flex1">
            <textarea id="telescope-info"  placeholder="INFO"></textarea>
            <textarea id="pec_table" placeholder="PEC Table"></textarea>       
        </div>
        <div id="result-boxes" class = "flex1">
            <textarea id="result" placeholder="Result"></textarea>
        </div>
        <iframe id="terminal_frame" src="{{ url_for('terminal') }}" width="720" height="480" class="hidden"></iframe>
    </div>
    

    <script>

        last_info = last_pec = "";

        function showTerminal() {
            document.getElementById('info-boxes').classList.toggle('hidden');
            document.getElementById('result-boxes').classList.toggle('hidden');
            document.getElementById('terminal_frame').classList.toggle('hidden');
        }

        function appendToResult(message) {
            const resultTextarea = document.getElementById('result');
            resultTextarea.value += message + '\n';
        }

        function setInfo(message) {
            const resultTextarea = document.getElementById('telescope-info');
            resultTextarea.value = message;
        }

        function setPEC(message) {
            const resultTextarea = document.getElementById('pec_table');
            resultTextarea.value = message;
        }
        

        function sendDirection(direction) {
            fetch('/control_move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `direction=${direction}`
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Success: ' + JSON.stringify(data));
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function sendStop() {
            fetch('/control_stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `direction=`
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Success: ' + JSON.stringify(data));
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function receivePEC() {
            fetch('/command_receivePEC', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const pecTable = data.pec_table;
                    const formattedTable = pecTable.map((value, index) => {
                        return index % 2 === 0 ? `${value},` : `${value}\n`;
                    }).join('');
                    last_pec = formattedTable;
                    setPEC(last_pec)
                    appendToResult('Received PEC table successfully.');
                } else {
                    appendToResult('Error: ' + data.message);
                }
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function sendPEC() {
            const pecTableText = document.getElementById('pec_table').value;
            const pecTableLines = pecTableText.split('\n');
            const pecTable = [];

            pecTableLines.forEach(line => {
                const [x, y] = line.split(',').map(Number);
                if (!isNaN(x) && !isNaN(y)) {
                    pecTable.push(x, y);
                }
            });

            fetch('/command_sendPEC', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pec_table: pecTable })
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Success: ' + JSON.stringify(data));
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }


        function uploadFirmware() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            appendToResult('Starting firmware upload. Please do not disconnect telescope.');
            fetch('/command_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Upload Success: ' + JSON.stringify(data, null, 2));
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function resetArduino() {
            fetch('/command_reset', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Reset Success: ' + JSON.stringify(data));
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function sendAutoguiderCommand(start) {

            fetch('/command_autoguider', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ start: start })
            })
            .then(response => response.json())
            .then(data => {
                appendToResult('Success: ' + JSON.stringify(data));
            })
            .catch(error => {
                appendToResult('Error:', error);
            });
        }

        function getInfo() {
            fetch('/command_info', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                last_info = data.info;
                setInfo(last_info)
            })
            .catch((error) => {
                appendToResult('Error: ' + error);
            });
        }

        function updateScopeInfo() {
            fetch('/scope_info')
                .then(response => response.json())
                .then(data => {
                    if(data.pier) {
                        document.getElementById('pier_w').checked = (data.pier === 'W');
                        document.getElementById('pier_e').checked = (data.pier === 'E');
                        document.getElementById('tracking').checked = (data.tracking === 'enabled');
                    }
                })  
            .catch(error => appendToResult('Error:', error));
        }
        
        setInterval(updateScopeInfo, 1000);

        function submitSetting(name, value) {
            fetch(`/set_${name}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `${name}=${value}`
            })
            .catch(error => appendToResult('Error:', error));
        }

        function setPier(pier) {
            submitSetting("pier", pier);
        }
        
        function setTracking(isTracking) {
            submitSetting("tracking", isTracking);
        }


    </script>
</body>
</html>