<!DOCTYPE html>
<html>
<head>
    <title>Autoguider Live Feed</title>
    <link rel="stylesheet" href="../static/style.css" />
    <script src="../static/chart.js"></script>
</head>
<body onload="Load()" class="night-mode">
    <table class="main-table">
        <tr>
            <td>
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <!-- Left-aligned buttons -->
                    <div>
                        <button class="command-button active" id="video_button" onclick="showVideoFeed()">Video</button>
                        <button class="command-button" id="thresh_button" onclick="showThreshFeed()">Threshold</button>
                        <button class="command-button" onclick="toggleNightMode()">Night Mode</button>
                        <button class="command-button active" id="errors_button" onclick="showCorrectionsChart()">Errors</button>
                        <button class="command-button" id="pec_button" onclick="showPECChart()">PEC</button>
                    </div>
        
                    <!-- Right-aligned button and text -->
                    <div>
                        <button class="command-button" onclick="shutdown()">Shutdown</button>
                        <span>Autoguider 0.7</span>
                    </div>
                </div>
            </td>
            <td>
                <button class="command-button active" id="control_frame_button" onclick="showControl()">Control</button>
                <button class="command-button" id="autoguider_panel_button" onclick="showGuider()">Guider</button>            
                <button class="command-button" id="camera_panel_button" onclick="showCamera()">Camera</button>            
                <button class="command-button" id="terminal_frame_button" onclick="showTerminal()">Terminal</button>
            </td>
        </tr>
        <tr>
            <td width="1280">
                <div id="video_container" width="1280">
                    <img id="video_feed" src="{{ url_for('video_feed') }}" width="1280" height="720">
                    <img id="thresh_feed" src="{{ url_for('thresh_feed') }}" width="1280" height="720" class="hidden">
                    <canvas id="canvas" width="1280" height="720"></canvas>
                    <canvas id="loupe" width="200" height="200" style="position: absolute; display: none; border: 1px solid #555;"></canvas>
                </div>
            </td>
            <td >
                <iframe id="control_frame" src="{{ url_for('control') }}" ></iframe>
                <iframe id="terminal_frame" src="{{ url_for('terminal') }}" class="hidden"></iframe>
                <table id="autoguider_panel" class="parameters-table hidden">                   
                    <tr>
                        <td>
                            <span id="star-lock-state" class="no-lock">NO LOCK</span><br>
                            <input type="checkbox" id="guiding" onchange="setGuiding(this.checked)">Guiding</input><br>
                            <input type="checkbox" id="dec_guiding" onchange="setDecGuiding(this.checked)">DEC guiding</input><br>
                            loop:<span id="last_loop_time">0</span> s<br>
                            frame:<span id="last_frame_time">0</span> s
                        </td>
                        <td>
                            <div class="two_buttons">
                                <img id="detail_feed" src="../static/Airy.png" alt="Not Available">
                                <div>dx:<span id="dx">0</span><br> dy:<span id="dy">0</span><br> focus:<span id="focus_metric">0</span></div>
                                <div>RA RMS (arcsec):<span id="ra_arcsec">0.0</span><br> DEC RMS (arcsec):<span id="dec_arcsec">0.0</span></div>
                            </div>
                        </td>
                        
                    </tr>

                    <tr class = "controller-row">
                        <td>
                            <button class="command-button" onclick="acquire()" title="Acquire a star for tracking">Acquire Star</button>
                        </td>
                        <td>
                            <button class="command-button" onclick="calibrate(false)" title="Calibrate autoguider camera RA/DEC axis orientation">Calibrate</button>
                            <button class="command-button" onclick="calibrate(true)" title="Calibrate telescope backlash compensation. Best use on stationary target with tracking disabled.">Cal+backlash</button>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label>Guide method:</label></td>
                        <td>
                            <div>
                                <input type="radio" id="methodABS" name="guide_method" value="ABS" onchange="submitGuideMethod(this.value)">
                                <label for="methodABS">ABS</label>
                                <input type="radio" id="methodREL" name="guide_method" value="REL" onchange="submitGuideMethod(this.value)">
                                <label for="methodREL">REL</label>
                                <input type="radio" id="methodPID" name="guide_method" value="PID" onchange="submitGuideMethod(this.value)" checked>
                                <label for="methodPID">PID</label>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label>Save frames:</label></td>
                        <td>
                            <div>
                                <input type="checkbox" id="save_frames" onchange="submitSaveFrames(this.checked)">Save</input>
                            </div>
                        </td>
                    </tr>

                    <tr class = "controller-row">
                        <td><label for="guide_interval">Guide interval:</label></td>
                        <td>
                            <input type="range" id="guide_interval" name="guide_interval" min="0" max="10" step="0.1" value="{{ guide_interval }}" oninput="submitGuideInterval()">
                            <span id="guide_interval_value">{{ guide_interval }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="guide_pulse">Guide pulse:</label></td>
                        <td>
                            <input type="range" id="guide_pulse" name="guide_pulse" min="0" max="2" step="0.1" value="{{ guide_pulse }}" oninput="submitGuidePulse()">
                            <span id="guide_pulse_value">{{ guide_pulse }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="max_drift">Max Drift:</label></td>
                        <td>
                            <input type="range" id="max_drift" name="max_drift" min="0" max="10" step = "0.1" value="{{ max_drift }}" oninput="submitMaxDrift()">
                            <span id="max_drift_value">{{ max_drift }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="star_size">Star Size:</label></td>
                        <td>
                            <input type="range" id="star_size" name="star_size" min="1" max="20" value="{{ star_size }}" oninput="submitStarSize()">
                            <span id="star_size_value">{{ star_size }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="rotation_angle">Rotation Angle (deg):</label></td>
                        <td>
                            <input type="range" id="rotation_angle" name="rotation_angle" min="-180" max="180" value="{{ rotation_angle }}" step="1" oninput="submitRotationAngle()">
                            <span id="rotation_angle_value">{{ rotation_angle }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="threshold">Threshold:</label></td>
                        <td>
                            <input type="range" id="threshold" name="threshold" min="0" max="255" value="{{ threshold }}" onchange="submitThreshold()">
                            <span id="threshold_value">{{ threshold }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="pid_p">PID p:</label></td>
                        <td>
                            <input type="range" id="pid_p" name="pid_p" min="0.0" max="10.0" step="0.01" value="0" onchange="submitPID()">
                            <span id="pid_p_value">0</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="pid_i">PID i:</label></td>
                        <td>
                            <input type="range" id="pid_i" name="pid_i" min="0.0" max="5.0" step="0.01" value="0" onchange="submitPID()">
                            <span id="pid_i_value">0</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="pid_d">PID d:</label></td>
                        <td>
                            <input type="range" id="pid_d" name="pid_d" min="0.0" max="5.0" step="0.01" value="0" onchange="submitPID()">
                            <span id="pid_d_value">0</span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div >
                                <table style="padding:0px;">
                                    <tr>
                                        <td style="width:50px;"></td>
                                        <td>
                                            <button class="control-button" onclick="sendCorrection('n')">↑</button>
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td style="width:50px;">
                                            <button class="control-button" onclick="sendCorrection('e')">←</button>
                                        </td>
                                        <td></td>
                                        <td>
                                            <button class="control-button" onclick="sendCorrection('w')">→</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width:50px;"></td>
                                        <td>
                                            <button class="control-button" onclick="sendCorrection('s')">↓</button>
                                        </td>
                                        <td></td>
                                    </tr>
                                </table>                               
                            </div>
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>

                <table id="camera_panel" class="parameters-table hidden">                   

                    <tr class = "controller-row">
                        <td>
                            <button class="command-button" onclick="saveFrame()" title="Save the current video frame to disk">Save Frame</button>
                        </td>
                        <td>
                            <span id="camera_info">Cmera running at: 10 FPS 1280x720 MJPG frame time 0.97s </span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="pixel_scale">Pixel Scale (arcsec/pixel):</label></td>
                        <td>
                            <input type="range" id="pixel_scale" name="pixel_scale" min="0.1" max="10.0" value="{{ pixel_scale }}" step="0.1" onchange="submitPixelScale()">
                            <span id="pixel_scale_value">{{ pixel_scale }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="integrate_frames">Int Frames (1 - 20):</label></td>
                        <td>
                            <input type="range" id="integrate_frames" name="integrate_frames" min="1" max="20" step="1" value="{{ integrate_frames }}" onchange="submitIntegrate_frames()">
                            <span id="integrate_frames_value">{{ integrate_frames }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="r_channel">R Channel:</label></td>
                        <td>
                            <input type="range" id="r_channel" name="r_channel" min="0.0" max="1.0" step="0.01" value="{{ r_channel }}" onchange="submitChannels()">
                            <span id="r_channel_value">{{ r_channel }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="g_channel">G Channel:</label></td>
                        <td>
                            <input type="range" id="g_channel" name="g_channel" min="0.0" max="1.0" step="0.01" value="{{ g_channel }}" onchange="submitChannels()">
                            <span id="g_channel_value">{{ g_channel }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label for="b_channel">B Channel:</label></td>
                        <td>
                            <input type="range" id="b_channel" name="b_channel" min="0.0" max="1.0" step="0.01" value="{{ b_channel }}" onchange="submitChannels()">
                            <span id="b_channel_value">{{ b_channel }}</span>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label >Sensor size/scope FL:</label></td>
                        <td>
                            <div>
                                <input class="num_input" type="text" id="sensor_width-input" placeholder="0">
                                <label for="sensor_width-input">mm X</label>
                                <input class="num_input" type="text" id="sensor_height-input" placeholder="0">
                                <label for="sensor_height-input">mm FL</label>
                                <input class="num_input" type="text" id="sensor_focal-input" placeholder="0">
                                <label for="sensor_focal-input">mm </label>
                                <button class="command-button" title="calculate pixel scale" onclick="calculatePixelScale()">Calculate</button>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label>Hot pixel mask:</label></td>
                        <td>
                            <div>
                                <button class="command-button" title="Capture hot pixel mask" onclick="captureHotPixelMask()">Capture</button>
                                <button class="command-button" title="Clear hot pixel mask" onclick="clearHotPixelMask()">Clear</button>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td colspan="2">
                            <hr style="border: 1px solid #ccc; width: 100%;">
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label >Resolution:</label></td>
                        <td>
                            <div>
                                <input type="radio" id="res1080" name="resolution" value="1920x1080" onchange="submitResolution(this.value)">
                                <label for="res1080">1920x1080</label>
                                <input type="radio" id="res1280" name="resolution" value="1280x720" onchange="submitResolution(this.value)" checked>
                                <label for="res1280">1280x720</label>
                                <input type="radio" id="res800" name="resolution" value="800x600" onchange="submitResolution(this.value)">
                                <label for="res800">800x600</label>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label >Video mode:</label></td>
                        <td>
                            <div>
                                <input type="radio" id="MJPG" name="video-mode" value="MJPG" onchange="submitVideoMode(this.value)" checked>
                                <label for="MJPG">MJPG</label>
                                <input type="radio" id="YUYV" name="video-mode" value="YUYV" onchange="submitVideoMode(this.value)">
                                <label for="YUYV">YUYV</label>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label >Camera FPS:</label></td>
                        <td>
                            <div>
                                <input type="radio" id="FPS20" name="camera-fps" value="20" onchange="submitCameraFPS(this.value)" checked>
                                <label for="FPS20">20</label>
                                <input type="radio" id="FPS10" name="camera-fps" value="10" onchange="submitCameraFPS(this.value)">
                                <label for="FPS10">10</label>
                                <input type="radio" id="FPS5" name="camera-fps" value="5" onchange="submitCameraFPS(this.value)">
                                <label for="FPS5">5</label>
                            </div>
                        </td>
                    </tr>
                    <tr class = "controller-row">
                        <td><label >Camera color:</label></td>
                        <td>
                            <div>
                                <input type="radio" id="camera_color_true" name="camera_color" value="true" onchange="submitCameraColor(true)" checked>
                                <label for="camera_color_true">color</label>
                                <input type="radio" id="camera_color_false" name="camera_color" value="false" onchange="submitCameraColor(false)">
                                <label for="camera_color_true">grayscale</label>
                            </div>
                        </td>
                    </tr>

                </table>


            </td>
        </tr>
    </table>
   
    <canvas id="correctionsChart" width="1900px" height="200px"></canvas>
    <canvas id="pecChart" width="1900px" height="200px" style="display: none;"></canvas>
</body>
<script src="../static/loupe.js"></script>
<script>
    let correctionsChart;

    function initializeChart() {
        const ctx = document.getElementById('correctionsChart').getContext('2d');
        correctionsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                { label: 'RA correction(abs)', data: [], borderColor: 'yellow', fill: false, pointRadius: 0 },
                { label: 'DEC correction(abs)', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
                { label: 'RA correction(speed)', data: [], borderColor: 'green', fill: false, pointRadius: 0 },
                { label: 'DEC correction(speed)', data: [], borderColor: 'orange', fill: false, pointRadius: 0 },
                { label: 'RA error (arcsec)', data: [], borderColor: 'purple', fill: false, pointRadius: 0 },
                { label: 'DEC error (arcsec)', data: [], borderColor: 'brown', fill: false, pointRadius: 0 },
                ],
            },
            options: {
                responsive: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Time' },
                        grid: {
                            color: '#919191', // Set grid line color
                        },
                        ticks: {
                            maxTicksLimit: 10, // Limit the number of ticks shown
                            maxRotation: 0, // Prevent rotation of ticks
                            minRotation: 0, // Ensure ticks are horizontal
                        },
                    },
                    y: {
                        title: { display: true, text: 'Values' },
                        grid: {
                            color: '#919191', // Set grid line color
                        },
                    },
                },
            },
        });
    }

    let pecChart;

    function initializePECChart() {
        const ctx = document.getElementById('pecChart').getContext('2d');
        pecChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'RA Error (arcsec)',
                        data: [], // Points will be added dynamically
                        borderColor: 'purple',
                        backgroundColor: 'purple',
                        pointRadius: 3,
                    },
                ],
            },
            options: {
                responsive: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'PEC Progress (%)' },
                        min: 0,
                        max: 99, // Static grid for x-axis
                        grid: { color: '#919191' },
                        ticks: { stepSize: 10 },
                    },
                    y: {
                        title: { display: true, text: 'RA Error (arcsec)' },
                        grid: { color: '#919191' },
                    },
                },
            },
        });
    }
    function Load() {

        // Call this function once when the page loads
        initializeChart();
        initializePECChart(); 
        updateCorrections();
        loadCameraProperties(); 
    }
    
    const ws = new WebSocket('ws://' + window.location.hostname + '/autoguider_socket');
    
    ws.onmessage = function(event) {
        processCorrections(JSON.parse(event.data));
    };

    ws.onclose = function() {
        console.error("Websocket closed.")
    };


    //setInterval(updateCorrections, 1000);

    function updateCorrections() {
        fetch('/properties')
            .then(response => response.json())
            .then(data => {
                processCorrections(data);
            })
            .catch(error => console.error('Error:', error.message));
    }

    function processCorrections(data) {

        if(data.status === 'error') {
            // autoguider is off
            return;
        }
        
        document.getElementById('last_loop_time').textContent = data.last_loop_time;
        document.getElementById('last_frame_time').textContent = data.last_frame_time;

        document.getElementById('dx').textContent = data.last_correction.dx.toFixed(2);
        document.getElementById('dy').textContent = data.last_correction.dy.toFixed(2);
        document.getElementById('focus_metric').textContent = data.focus_metric.toFixed(1);
        
        //document.getElementById('ra_arcsec').textContent = data.last_correction.ra_arcsec.toFixed(1);
        //document.getElementById('dec_arcsec').textContent = data.last_correction.dec_arcsec.toFixed(1);
        document.getElementById('threshold').value = data.gray_threshold;
        document.getElementById('threshold_value').textContent = data.gray_threshold;
        document.getElementById('max_drift').value = data.max_drift;
        document.getElementById('max_drift_value').textContent = data.max_drift;

        document.getElementById('star_size').value = data.star_size;
        document.getElementById('star_size_value').textContent = data.star_size;

        document.getElementById('rotation_angle').value = data.rotation_angle.toFixed(3);
        document.getElementById('rotation_angle_value').textContent = data.rotation_angle.toFixed(3);

        document.getElementById('pixel_scale').value = data.pixel_scale;
        document.getElementById('pixel_scale_value').textContent = data.pixel_scale;

        document.getElementById('integrate_frames').value = data.integrate_frames;
        document.getElementById('integrate_frames_value').textContent = data.integrate_frames;

        document.getElementById('r_channel').value = data.r_channel;
        document.getElementById('r_channel_value').textContent = data.r_channel;
        document.getElementById('g_channel').value = data.g_channel;
        document.getElementById('g_channel_value').textContent = data.g_channel;
        document.getElementById('b_channel').value = data.b_channel;
        document.getElementById('b_channel_value').textContent = data.b_channel;

        document.getElementById('guiding').checked = data.guiding;
        document.getElementById('dec_guiding').checked = data.dec_guiding;
        document.getElementById('save_frames').checked = data.save_frames;
        
        document.getElementById('guide_pulse').value = data.guide_pulse;
        document.getElementById('guide_pulse_value').textContent = data.guide_pulse;
        document.getElementById('guide_interval').value = data.guide_interval;
        document.getElementById('guide_interval_value').textContent = data.guide_interval;

        document.getElementById('pid_p').value = data.pid_p;
        document.getElementById('pid_p_value').textContent = data.pid_p;
        document.getElementById('pid_i').value = data.pid_i;
        document.getElementById('pid_i_value').textContent = data.pid_i;
        document.getElementById('pid_d').value = data.pid_d;
        document.getElementById('pid_d_value').textContent = data.pid_d;

        const methodRadio = document.querySelector(`input[name="guide_method"][value="${data.guide_method}"]`);
        if (methodRadio) {
            methodRadio.checked = true;
        }
        
        // Set the camera FPS radio button
        const fpsRadio = document.querySelector(`input[name="camera-fps"][value="${data.camera_fps}"]`);
        if (fpsRadio) {
            fpsRadio.checked = true;
        }

        // Set the resolution radio button
        const resolutionRadio = document.querySelector(`input[name="resolution"][value="${data.resolution.width}x${data.resolution.height}"]`);
        if (resolutionRadio) {
            resolutionRadio.checked = true;
        }

        // Set the video mode radio button
        const videoModeRadio = document.querySelector(`input[name="video-mode"][value="${data.video_mode}"]`);
        if (videoModeRadio) {
            videoModeRadio.checked = true;
        }

        // Set the camera color radio button
        const colorRadioButton = document.querySelector(`input[name="camera_color"][value="${data.camera_color}"]`);
        if (colorRadioButton) {
            colorRadioButton.checked = true;
        }


        // Update the camera_info element
        const cameraInfo = document.getElementById('camera_info');
        if (cameraInfo) {
            cameraInfo.textContent = `FPS:${data.camera_fps} ${data.video_mode} ${data.resolution.width}x${data.resolution.height} exposure:${data.exposure_ms}ms frame time:${data.last_frame_time.toFixed(2)}s`;
        }


        // Update the star lock state
        const starLockState = document.getElementById('star-lock-state');
        if (data.star_locked) {
            starLockState.textContent = "LOCK";
            starLockState.classList.remove('no-lock');
            starLockState.classList.add('lock');
        } else {
            starLockState.textContent = "NO LOCK";
            starLockState.classList.remove('lock');
            starLockState.classList.add('no-lock');
        }


        // Decode the Base64 image and set it as the src of the detail_feed image
        const detailFeed = document.getElementById('detail_feed');
        if (data.centroid_image) {
            detailFeed.src = `data:image/png;base64,${data.centroid_image}`;
            detailFeed.alt = "Detail Feed";
        } else {
            detailFeed.src = "../static/Airy.png"; // Fallback to placeholder
            detailFeed.alt = "Not Available";
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (data.tracked_centroid) {
            ctx.strokeStyle = 'green';
            ctx.beginPath();
            ctx.arc(data.tracked_centroid[0]*canvas.width, data.tracked_centroid[1]*canvas.height, 10, 0, 2 * Math.PI);
            ctx.stroke();
        }

        if (data.current_centroid) {
            ctx.strokeStyle = 'red';
            ctx.beginPath();
            ctx.arc(data.current_centroid[0]*canvas.width, data.current_centroid[1]*canvas.height, 10, 0, 2 * Math.PI);
            ctx.stroke();
        }
        
        
        drawAxes(data.rotation_angle);

        // Update the chart with new data
        const currentTime = new Date().toLocaleTimeString(); // Use current time as the label

        correctionsChart.data.labels.push(currentTime);
        // Add new data points to each dataset
        if (data.star_locked) {
            correctionsChart.data.datasets[0].data.push(data.last_correction.ra);
            correctionsChart.data.datasets[1].data.push(data.last_correction.dec);
            correctionsChart.data.datasets[2].data.push(data.last_correction.ra_speed/10.0);
            correctionsChart.data.datasets[3].data.push(data.last_correction.dec_speed/10.0);
            correctionsChart.data.datasets[4].data.push(data.last_correction.ra_arcsec);
            correctionsChart.data.datasets[5].data.push(data.last_correction.dec_arcsec);
        } else {
            // Add null to the main datasets to maintain alignment
            for(i=0;i<6;i++) {
                correctionsChart.data.datasets[i].data.push(null);
            }
        }

        // Limit the number of data points to avoid overcrowding
        if (correctionsChart.data.labels.length > 120) {
            correctionsChart.data.labels.shift(); // Remove the oldest label
            correctionsChart.data.datasets.forEach(dataset => {
            if (dataset.data.length > 0) {
                dataset.data.shift(); // Remove the oldest data point
                }
            });
        }

        // Update the chart
        correctionsChart.update();


        // Update the PEC chart
        if (data.pec_position && data.last_correction.ra_arcsec !== undefined) {
            pecChart.data.datasets[0].data.push({
                x: data.pec_position, // PEC progress (x-axis)
                y: data.last_correction.ra_arcsec, // RA error (y-axis)
            });

            // Limit the number of points to avoid overcrowding
            /*if (pecChart.data.datasets[0].data.length > 100) {
                pecChart.data.datasets[0].data.shift();
            }*/

            pecChart.update();
        }

        calculateRMS();
    }

    function showCorrectionsChart() {
        document.getElementById('correctionsChart').style.display = 'block';
        document.getElementById('pecChart').style.display = 'none';

        document.getElementById('errors_button').classList.add('active');
        document.getElementById('pec_button').classList.remove('active');

    }

    function showPECChart() {
        document.getElementById('correctionsChart').style.display = 'none';
        document.getElementById('pecChart').style.display = 'block';

        document.getElementById('errors_button').classList.remove('active');
        document.getElementById('pec_button').classList.add('active');
    }

    function calculateRMS() {
        // Get the RA and DEC datasets from the chart
        const raArcsecData = correctionsChart.data.datasets[4].data; // RA Arcsec dataset
        const decArcsecData = correctionsChart.data.datasets[5].data; // DEC Arcsec dataset

        // Filter out null values (in case of missing data points)
        const validRaData = raArcsecData.filter(value => value !== null);
        const validDecData = decArcsecData.filter(value => value !== null);

        // Calculate RMS for RA
        const raRMS = Math.sqrt(validRaData.reduce((sum, value) => sum + value ** 2, 0) / validRaData.length);

        // Calculate RMS for DEC
        const decRMS = Math.sqrt(validDecData.reduce((sum, value) => sum + value ** 2, 0) / validDecData.length);

        // Update the RA and DEC elements with the RMS values
        document.getElementById('ra_arcsec').textContent = raRMS.toFixed(2);
        document.getElementById('dec_arcsec').textContent = decRMS.toFixed(2);
    }

    function drawAxes(rotation_angle) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const length = 150; // Length of the axes

        // Convert rotation angle to radians
        const angleRad = rotation_angle * (Math.PI / 180);

        // Calculate the end points of the RA and DEC axes
        // Y axis is upside down.. so we have minus sign with Y
        const raX = centerX + length * Math.cos(angleRad);
        const raY = centerY - length * Math.sin(angleRad);
        const decX = centerX - length * Math.sin(angleRad);
        const decY = centerY - length * Math.cos(angleRad);

        // Draw the RA axis
        ctx.strokeStyle = 'green';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(raX, raY);
        ctx.stroke();

        // Draw the DEC axis
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(decX, decY);
        ctx.stroke();

        // Add labels
        ctx.font = '12px Arial';
        ctx.fillStyle = 'green';
        ctx.fillText('RA(W)', raX + 5, raY + 5);
        ctx.fillText('DEC(N)', decX + 5, decY + 5);
    }

    function submitChannels() {
        const r_channel = document.getElementById('r_channel').value;
        const g_channel = document.getElementById('g_channel').value;
        const b_channel = document.getElementById('b_channel').value;

        document.getElementById('r_channel_value').textContent = r_channel;
        document.getElementById('g_channel_value').textContent = g_channel;
        document.getElementById('b_channel_value').textContent = b_channel;


        fetch('/set_channels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ r_channel, g_channel, b_channel }),
        })
    }

    function submitSetting(name, value) {
        fetch(`/set_${name}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `${name}=${value}`
        });        
    }

    function submitSaveFrames(value) {
        submitSetting("save_frames", value);
    }

    function submitThreshold() {
        const threshold = document.getElementById('threshold').value;
        document.getElementById('threshold_value').textContent = threshold;
        submitSetting("threshold", threshold);
    }

    function submitMaxDrift() {
        const max_drift = document.getElementById('max_drift').value;
        document.getElementById('max_drift_value').textContent = max_drift;
        submitSetting("max_drift", max_drift);
    }

    function submitStarSize() {
        const star_size = document.getElementById('star_size').value;
        document.getElementById('star_size_value').textContent = star_size;
        submitSetting("star_size", star_size);
    }

    function submitRotationAngle() {
        const rotation_angle = document.getElementById('rotation_angle').value;
        document.getElementById('rotation_angle_value').textContent = rotation_angle;
        submitSetting("rotation_angle", rotation_angle);
    }

    function submitPixelScale() {
        const pixel_scale = document.getElementById('pixel_scale').value;
        document.getElementById('pixel_scale_value').textContent = pixel_scale;
        submitSetting("pixel_scale", pixel_scale);
    }

    function submitGuideInterval() {
        const guide_interval = document.getElementById('guide_interval').value;
        document.getElementById('guide_interval_value').textContent = guide_interval;
        submitSetting("guide_interval", guide_interval);
    }
    
    function submitGuidePulse() {
        const guide_pulse = document.getElementById('guide_pulse').value;
        document.getElementById('guide_pulse_value').textContent = guide_pulse;
        submitSetting("guide_pulse", guide_pulse);
    }

    function submitGuideMethod(value) {
        submitSetting("guide_method", value);
    }
    
    function submitIntegrate_frames() {
        const integrate_frames = document.getElementById('integrate_frames').value;
        document.getElementById('integrate_frames_value').textContent = integrate_frames;
        submitCameraProperties(JSON.stringify({ "integrate_frames":integrate_frames }));
    }

    function submitCameraFPS(value) {
        submitCameraProperties(JSON.stringify({ "camera_fps":value }));
    }
    function submitVideoMode(value) {
        submitCameraProperties(JSON.stringify({ "video_mode":value }));
    }
    function submitResolution(value) {
        const [width, height] = value.split('x').map(Number); // Split and convert to numbers
        submitCameraProperties(JSON.stringify({ width, height }));
    }

    function submitCameraColor(value) {        
        submitCameraProperties(JSON.stringify({ "camera_color" : value }));
    }

    function captureHotPixelMask() {
        submitSetting("hot_pixel_mask", true);
    }

    function clearHotPixelMask() {
        submitSetting("hot_pixel_mask", false);
    }


    function submitCameraProperties(properties) {
        fetch('/set_camera_properties', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: properties,
        })
    }


    
    function submitPID() {
        const pid_p = document.getElementById('pid_p').value;
        const pid_i = document.getElementById('pid_i').value;
        const pid_d = document.getElementById('pid_d').value;
        document.getElementById('pid_p_value').textContent = pid_p;
        document.getElementById('pid_i_value').textContent = pid_i;
        document.getElementById('pid_d_value').textContent = pid_d;
        fetch('/set_pid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pid_p,pid_i, pid_d }),
        })
    }

    function setGuiding(isGuiding) {
      submitSetting("guiding", isGuiding);
    }
    function setDecGuiding(isGuiding) {
      submitSetting("dec_guiding", isGuiding);
    }

    function acquire() {
        fetch('/acquire', { method: 'POST' })
            .then(response => console.log('Acquisition triggered'))
            .catch(error => console.error('Acquisition error:', error));
    }

    function calibrate(with_backlash) {
        fetch('/calibrate', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `with_backlash=${with_backlash}`
        })        
        .then(response => console.log('Calibration triggered'))
        .catch(error => console.error('Calibration error:', error));
    }


    document.getElementById("canvas").addEventListener('click', function(event) {
        const rect = this.getBoundingClientRect();
        const x = (event.clientX - rect.left)/rect.width; // X relative to image
        const y = (event.clientY - rect.top)/rect.height;  // Y relative to image
        fetch('/acquire', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `x=${x}&y=${y}`
        })
        .then(response => console.log(`Acquisition at (${x}, ${y}) triggered`))
        .catch(error => console.error('Acquisition error:', error));
    });

    function showVideoFeed() {
        document.getElementById('video_feed').src = "{{ url_for('video_feed') }}";
        document.getElementById('thresh_feed').src = '';

        document.getElementById('video_feed').classList.remove('hidden');
        document.getElementById('canvas').classList.remove('hidden');
        document.getElementById('thresh_feed').classList.add('hidden');

        document.getElementById('video_button').classList.add('active');
        document.getElementById('thresh_button').classList.remove('active');
    }

    function showThreshFeed() {
        document.getElementById('video_feed').src = '';
        document.getElementById('thresh_feed').src = "{{ url_for('thresh_feed') }}";
        document.getElementById('video_feed').classList.add('hidden');
        document.getElementById('canvas').classList.remove('hidden');
        document.getElementById('thresh_feed').classList.remove('hidden');

        document.getElementById('video_button').classList.remove('active');
        document.getElementById('thresh_button').classList.add('active');
    }


    function showPanel(panel) {
        document.getElementById('control_frame').classList.add('hidden');
        document.getElementById('autoguider_panel').classList.add('hidden');
        document.getElementById('camera_panel').classList.add('hidden');
        document.getElementById('terminal_frame').classList.add('hidden');
        document.getElementById(panel).classList.remove('hidden');

        document.getElementById('control_frame_button').classList.remove('active');
        document.getElementById('autoguider_panel_button').classList.remove('active');
        document.getElementById('camera_panel_button').classList.remove('active');
        document.getElementById('terminal_frame_button').classList.remove('active');
        document.getElementById(panel + '_button').classList.add('active');        
    }
    function showControl() {
        showPanel('control_frame');
    }
    function showGuider() {
        showPanel('autoguider_panel');
    }
    function showCamera() {
        showPanel('camera_panel');
    }
    function showTerminal() {
        showPanel('terminal_frame');
    }


    function saveFrame() {
        fetch('/save_frame', {
            method: 'POST',
        })
        .then(response => {
            if (response.ok) {
                return response.blob(); // Convert the response to a Blob
            } else {
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to save frame');
                });
            }
        })
        .then(blob => {
            // Create a temporary link element
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'saved_frame.png'; // Set the file name
            document.body.appendChild(a);
            a.click(); // Trigger the download
            a.remove(); // Remove the link element
            window.URL.revokeObjectURL(url); // Revoke the object URL
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }


    function sendCorrection(direction) {
        fetch('/control_correction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `direction=${direction}`
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.log('Error:', error);
        });
    }

    function shutdown() {
        if (confirm("Are you sure you want to shut down the telescope?")) {
            fetch('/shutdown', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.log('Error:', error);
            });
        } else {
            console.log('Shutdown canceled.');
        }        

    }

    function toggleNightMode() {
        const body = document.body;
        body.classList.toggle('night-mode'); // Toggle the 'night-mode' class
    }



    function loadCameraProperties() {
        fetch('/get_camera_properties')
        .then(response => response.json())
        .then(data => {
            const cameraPanel = document.getElementById('camera_panel');

            for (const [property, details] of Object.entries(data)) {
                const row = document.createElement('tr');
                row.className = 'controller-row';

                const labelCell = document.createElement('td');
                labelCell.innerHTML = `<label for="${property}">${property.replace(/_/g, ' ')}:</label>`;
                row.appendChild(labelCell);

                const controlCell = document.createElement('td');
                

                if (details.type === 'int') {
                    // Create a slider for integer properties
                    if(property === "exposure_time_absolute") {
                        input_min = 0;
                        input_max = Math.log(details.max)/Math.log(Math.sqrt(2))+0.1;
                        value = Math.log(details.value)/Math.log(Math.sqrt(2));
                        controlCell.innerHTML = `
                        <input type="range" id="${property}" name="${property}" 
                            min="${input_min}" max="${input_max}" step="0.1"
                            value="${value}" 
                            oninput="updateExposure('${property}', this.value, ${details.max})"
                            onchange="submitProperty( '${property}', document.getElementById('exposure_time_absolute_value').textContent)">
                        <span id="${property}_value">${details.value}</span>`;
                    } else {
                        controlCell.innerHTML = `
                        <input type="range" id="${property}" name="${property}" 
                            min="${details.min}" max="${details.max}" step="${details.step}" 
                            value="${details.value}" 
                            oninput="updateLabel('${property}', this.value)"
                            onchange="submitProperty('${property}', this.value)">
                        <span id="${property}_value">${details.value}</span>`;
                    }
                } else if (details.type === 'bool') {
                    // Create a checkbox for boolean properties
                    controlCell.innerHTML = `
                        <input type="checkbox" id="${property}" name="${property}" 
                            ${details.value ? 'checked' : ''} 
                            onchange="submitProperty('${property}', this.checked ? 1 : 0)">
                    `;
                } else if (details.type === 'menu') {
                    // Create radio buttons for menu properties
                    const options = Object.entries(details.options)
                        .map(([key, label]) => `
                            <input type="radio" id="${property}_${key}" name="${property}" value="${key}" 
                                ${details.value == key ? 'checked' : ''} 
                                onchange="submitProperty('${property}', ${key})">
                            <label for="${property}_${key}">${label}</label>
                        `);//.join('<br>');
                    controlCell.innerHTML = options;
                }

                row.appendChild(controlCell);
                cameraPanel.appendChild(row);
            }

            // blank row
            const row = document.createElement('tr');
            row.innerHTML="<td></td><td></td>"
            cameraPanel.appendChild(row);


        })
        .catch(error => console.error('Error fetching camera properties:', error));
    }

    function updateExposure(property, value, max_value) {
        const exposure = Math.min(Math.pow(Math.sqrt(2), value), max_value);
        const label = document.getElementById(`${property}_value`);

        if (label) {
            label.textContent = exposure.toFixed(0); // Update label
        }
    }

    function updateLabel(property, value) {
        const label = document.getElementById(`${property}_value`);
        if (label) {
            label.textContent = value;
        }
    }

    function submitProperty(name, value) {
        fetch('/set_direct_camera_property', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ "name" : name, "value" : value }),
        })
        .then(response => console.log(`Property ${name} set to ${value}`))
        .catch(error => console.error(`Error setting property ${name}:`, error));
    }
 
    function calculatePixelScale() {
        const sensorWidth = parseFloat(document.getElementById('sensor_width-input').value);
        const resolutionWidth = parseFloat(document.querySelector('input[name="resolution"]:checked').value.split('x')[0]);
        const focalLength = parseFloat(document.getElementById('sensor_focal-input').value);

        if (isNaN(sensorWidth) || isNaN(resolutionWidth) || isNaN(focalLength) || focalLength === 0) {
            alert('Please enter valid values for sensor width, resolution, and focal length.');
            return;
        }

        const pixelScale = (sensorWidth*1000 / resolutionWidth) * (206.265 / focalLength);
        document.getElementById('pixel_scale_value').textContent = pixelScale.toFixed(2);
        alert(`Pixel Scale: ${pixelScale.toFixed(2)} arcsec/pixel`);
    }


</script>
</html>